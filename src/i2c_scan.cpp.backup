// I2C Scanner - 用于诊断 B-L475E-IOT01A 的 I2C 设备
#include <Arduino.h>
#include <Wire.h>

TwoWire Wire1_custom(PB11, PB10);  // SDA, SCL for sensor bus

void setup() {
  Serial.begin(115200);
  while (!Serial) {
    delay(10);
  }
  
  Serial.println("\n========================================");
  Serial.println("I2C Scanner for B-L475E-IOT01A");
  Serial.println("========================================");
  
  // 扫描默认 Wire (I2C1)
  Serial.println("\n[Scanning Wire (I2C1) - Default pins]");
  Wire.begin();
  scanI2C(Wire, "Wire (I2C1)");
  
  // 扫描 Wire 带强制引脚
  Serial.println("\n[Scanning Wire with forced pins PB11/PB10]");
  Wire.setSDA(PB11);
  Wire.setSCL(PB10);
  Wire.begin();
  scanI2C(Wire, "Wire (PB11/PB10)");
  
  // 扫描自定义 Wire1
  Serial.println("\n[Scanning Wire1_custom (PB11/PB10)]");
  Wire1_custom.begin();
  scanI2C(Wire1_custom, "Wire1_custom");
  
  Serial.println("\n========================================");
  Serial.println("Scan complete!");
  Serial.println("========================================");
}

void scanI2C(TwoWire &wire, const char* name) {
  byte error, address;
  int nDevices = 0;
  
  Serial.print("Scanning ");
  Serial.print(name);
  Serial.println("...");
  
  for(address = 1; address < 127; address++) {
    wire.beginTransmission(address);
    error = wire.endTransmission();
    
    if (error == 0) {
      Serial.print("Device found at 0x");
      if (address < 16) Serial.print("0");
      Serial.print(address, HEX);
      Serial.println(" !");
      nDevices++;
      
      // 识别常见设备
      if (address == 0x6A || address == 0x6B) {
        Serial.println("  -> Likely LSM6DSL (accelerometer/gyro)");
      }
    }
    else if (error == 4) {
      Serial.print("Unknown error at 0x");
      if (address < 16) Serial.print("0");
      Serial.println(address, HEX);
    }
  }
  
  if (nDevices == 0) {
    Serial.println("No I2C devices found");
  } else {
    Serial.print("Found ");
    Serial.print(nDevices);
    Serial.println(" device(s)");
  }
}

void loop() {
  delay(5000);
}

